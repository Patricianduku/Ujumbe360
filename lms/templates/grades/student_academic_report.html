{% extends 'parent_portal/base_parent.html' %}

{% block title %}Academic Report - {{ student.full_name }}{% endblock %}

{% block content %}
<div class="page-header fade-in">
    <h1>Academic Report</h1>
    <p class="text-secondary-green mb-0">{{ student.full_name }} ({{ student.admission_number }})</p>
</div>

{% if exam_labels %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Performance Trend</h5>
    </div>
    <div class="card-body">
        <canvas id="examTrendChart" height="100"></canvas>
    </div>
</div>
{% endif %}

<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Student Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <p><strong>Name:</strong> {{ student.full_name }}</p>
                <p><strong>Admission Number:</strong> {{ student.admission_number }}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Class:</strong> {{ student.class_level }} {{ student.stream|default:"" }}</p>
                <p><strong>Date of Birth:</strong> {{ student.date_of_birth|date:"M d, Y" }}</p>
            </div>
        </div>
    </div>
</div>

{% if exams_data %}
    {% for exam_data in exams_data %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{{ exam_data.exam.name }} - {{ exam_data.exam.term }} {{ exam_data.exam.year }}</h5>
            <span class="badge bg-primary">Average: {{ exam_data.average|floatformat:1 }}%</span>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Teacher Comment</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for grade in exam_data.grades %}
                        <tr>
                            <td><strong>{{ grade.subject.name }}</strong></td>
                            <td>{{ grade.score }}%</td>
                            <td>
                                <span class="badge 
                                    {% if grade.grade_letter == 'A' or grade.grade_letter == 'A-' %}bg-success
                                    {% elif grade.grade_letter == 'B+' or grade.grade_letter == 'B' or grade.grade_letter == 'B-' %}bg-info
                                    {% elif grade.grade_letter == 'C+' or grade.grade_letter == 'C' or grade.grade_letter == 'C-' %}bg-warning
                                    {% else %}bg-danger{% endif %}">
                                    {{ grade.grade_letter }}
                                </span>
                            </td>
                            <td>{{ grade.teacher_comment|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endfor %}
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No grades recorded for this student yet.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = {{ exam_labels|safe }};
    const data = {{ exam_averages|safe }};
    if (labels && labels.length && document.getElementById('examTrendChart')) {
        const ctx = document.getElementById('examTrendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Average Score',
                    data: data,
                    fill: false,
                    borderColor: '#4F46E5',
                    backgroundColor: '#4F46E5',
                    tension: 0.3,
                    pointRadius: 4,
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        suggestedMin: 0,
                        suggestedMax: 100,
                        ticks: { callback: (v) => v + '%' }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
